<h2>Caixa</h2>

<div class="error" *ngIf="error">{{ error }}</div>

<form [formGroup]="form" (ngSubmit)="registrarVenda()">
  <h3>Itens da Venda</h3>

  <div formArrayName="itens">
    <div class="item" *ngFor="let item of itens.controls; let i = index" [formGroupName]="i">
      <div>
        <label>Produto</label>
        <select formControlName="produtoId">
          <option [ngValue]="null">Selecione...</option>
          <option *ngFor="let p of produtos" [value]="p.id">
            {{ p.codigo }} - {{ p.nome }} ({{ p.precoUnitario | currency:'BRL' }})
          </option>
        </select>
      </div>
      <div>
        <label>Quantidade</label>
        <input type="number" formControlName="quantidade" />
      </div>
      <button type="button" (click)="removerItem(i)" [disabled]="itens.length === 1">Remover</button>
    </div>
  </div>

  <button type="button" (click)="adicionarItem()">Adicionar item</button>

  <div class="totais">
    <p><strong>Total:</strong> {{ getValorTotal() | currency:'BRL' }}</p>

    <div>
      <label>Valor recebido</label>
      <input type="number" formControlName="valorRecebido" step="0.01" />
    </div>

    <p><strong>Troco:</strong> {{ getTroco() | currency:'BRL' }}</p>
  </div>

  <button type="submit">Registrar Venda</button>
</form>

<div *ngIf="ultimaVenda" class="resumo">
  <h3>Última Venda Registrada</h3>
  <p>ID: {{ ultimaVenda.id }}</p>
  <p>Usuário: {{ ultimaVenda.usuarioNome }}</p>
  <p>Data/Hora: {{ ultimaVenda.dataHora | date:'short' }}</p>
  <p>Total: {{ ultimaVenda.valorTotal | currency:'BRL' }}</p>
  <p>Recebido: {{ ultimaVenda.valorRecebido | currency:'BRL' }}</p>
  <p>Troco: {{ ultimaVenda.troco | currency:'BRL' }}</p>

  <h4>Itens</h4>
  <ul>
    <li *ngFor="let it of ultimaVenda.itens">
      {{ it.produtoNome }} - {{ it.quantidade }} x {{ it.precoUnitario | currency:'BRL' }}
      = {{ it.subtotal | currency:'BRL' }}
    </li>
  </ul>
</div>
